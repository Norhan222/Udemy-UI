<div class="students-container">
  <!-- Top Navigation -->
  <div class="top-nav">
    <div class="max-w-7xl">
      <div class="nav-content">
        <div>
          <h1>{{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.TITLE' | translate }}</h1>
          <p class="subtitle">
            {{ stats.totalStudents }} {{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.SUBTITLE_STUDENTS' | translate }} ‚Ä¢
            {{ stats.totalCourses }} {{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.SUBTITLE_ENROLLMENTS' | translate }}
            <ng-container *ngIf="activeTab === 'completed'"> ‚Ä¢ {{ stats.completedCourses }} {{
              'INSTRUCTOR_PERFORMANCE.STUDENTS.SUBTITLE_COMPLETED' | translate }}</ng-container>
            <ng-container *ngIf="activeTab === 'in-progress'"> ‚Ä¢ {{ stats.inProgressCourses }} {{
              'INSTRUCTOR_PERFORMANCE.STUDENTS.SUBTITLE_IN_PROGRESS' | translate }}</ng-container>
          </p>
        </div>
      </div>
    </div>
  </div>

  <div class="max-w-7xl content-area">
    <!-- Tabs -->
    <div class="tabs">
      <button [class.active]="activeTab === 'all'" (click)="activeTab = 'all'; onFilterChange()">
        {{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.TAB_ALL' | translate }}
      </button>
      <button [class.active]="activeTab === 'in-progress'" (click)="activeTab = 'in-progress'; onFilterChange()">
        {{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.TAB_IN_PROGRESS' | translate }}
        <span class="badge">{{ inProgressCount }}</span>
      </button>
      <button [class.active]="activeTab === 'completed'" (click)="activeTab = 'completed'; onFilterChange()">
        {{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.TAB_COMPLETED' | translate }}
        <span class="badge">{{ completedCount }}</span>
      </button>
    </div>

    <!-- Search and Filters -->
    <div class="filters">
      <div class="search-box">
        <span class="search-icon">üîç</span>
        <input type="text" [placeholder]="'INSTRUCTOR_PERFORMANCE.STUDENTS.SEARCH_PLACEHOLDER' | translate"
          [(ngModel)]="searchTerm" (input)="onFilterChange()">
      </div>
      <div class="select-wrapper">
        <select [(ngModel)]="selectedCourse" (change)="onFilterChange()">
          <option *ngFor="let course of courses" [value]="course">
            {{ course === 'all' ? ('INSTRUCTOR_PERFORMANCE.REVIEWS.ALL_COURSES' | translate) : course }}
          </option>
        </select>
      </div>
    </div>

    <!-- Students List -->
    <div class="students-list">
      <div *ngFor="let student of filteredStudents" class="student-card">
        <!-- Student Header -->
        <div class="student-header" (click)="toggleExpand(student.id)">
          <div class="student-main">
            @if(student.profileImageUrl){
            <div >
            <img class="avatarImg" src="{{student.profileImageUrl}}">
            </div>
          }
          @else{
            <div class="avatar">{{ getInitials(student.name) }}</div>
          }
            <div class="student-details">
              <div class="name-row">
                <h3>{{ student.name }}</h3>
                <span class="separator">‚Ä¢</span>
                <span class="country">{{ student.country }}</span>
              </div>
              <p class="email">{{ student.email }}</p>
            </div>
          </div>
          <div class="student-stats">
            <div class="stat">
              <p class="stat-label">{{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.STAT_COURSES' | translate }}</p>
              <p class="stat-value">{{ student.enrolledCourses.length }}</p>
            </div>
            <div class="stat">
              <p class="stat-label">{{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.STAT_WATCH_TIME' | translate }}</p>
              <p class="stat-value">{{ student.totalWatchTime }}</p>
            </div>
            <span class="chevron" [class.rotated]="expandedStudent === student.id">‚ñº</span>
          </div>
        </div>

        <!-- Expanded Course Details -->
        <div *ngIf="expandedStudent === student.id" class="expanded-content">
          <div *ngFor="let course of student.enrolledCourses" class="course-item">
            <div class="course-header">
              <div class="course-info">
                <h4>{{ course.title }}</h4>
                <div class="course-meta">
                  <span>üìÖ {{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.ENROLLED_DATE' | translate }} {{ course.enrollDate
                    }}</span>
                  <span>‚Ä¢</span>
                  <span>{{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.LAST_ACCESSED' | translate }} {{ course.lastAccessed
                    }}</span>
                </div>
              </div>
              <div class="course-badges">
                <div class="rating-box">
                  <p class="rating-label">{{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.RATING_LABEL' | translate }}</p>
                  <div *ngIf="course.rating" class="stars">
                    <span *ngFor="let star of getStarArray(course.rating)"
                      [class.filled]="star <= course.rating">‚òÖ</span>
                  </div>
                  <span *ngIf="!course.rating" class="no-rating">{{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.NO_RATING' |
                    translate }}</span>
                </div>
                <div *ngIf="course.progress === 100" class="completed-badge">
                  <span class="icon">üèÜ</span>
                  <span>{{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.COMPLETED_BADGE' | translate }}</span>
                </div>
              </div>
            </div>

            <div class="progress-row">
              <div class="progress-bar-container">
                <div class="progress-bar" [ngClass]="getProgressColor(course.progress)"
                  [style.width.%]="course.progress"></div>
              </div>
              <span class="progress-text">{{ course.progress }}%</span>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="action-buttons">
            <button (click)="openMessageModal(student)" class="btn-secondary">
              <span class="icon">üí¨</span>
              {{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.BTN_MESSAGE' | translate }}
            </button>
            <button (click)="openPerformanceModal(student)" class="btn-secondary">
              <span class="icon">üìä</span>
              {{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.BTN_PERFORMANCE' | translate }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- No Results -->
    <div *ngIf="filteredStudents.length === 0" class="no-results">
      <p class="no-results-title">{{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.NO_RESULTS_TITLE' | translate }}</p>
      <p class="no-results-subtitle">{{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.NO_RESULTS_SUBTITLE' | translate }}</p>
    </div>
  </div>

  <!-- Message Modal -->
  <div *ngIf="showMessageModal" class="modal-overlay" (click)="closeMessageModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div>
          <h2>{{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.MODAL_SEND_MSG_TITLE' | translate }}</h2>
          <p class="modal-subtitle">{{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.MODAL_TO' | translate }} {{
            selectedStudentForAction?.name }}</p>
        </div>
        <button class="close-btn" (click)="closeMessageModal()">‚úï</button>
      </div>

      <div class="modal-body">
        <div class="form-group">
          <label>{{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.MODAL_SUBJECT' | translate }}</label>
          <input type="text" [(ngModel)]="messageSubject"
            [placeholder]="'INSTRUCTOR_PERFORMANCE.STUDENTS.MODAL_SUBJECT' | translate" class="form-input">
        </div>

        <div class="form-group">
          <label>{{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.MODAL_MESSAGE' | translate }}</label>
          <textarea [(ngModel)]="messageText"
            [placeholder]="'INSTRUCTOR_PERFORMANCE.STUDENTS.MODAL_MESSAGE' | translate" rows="8"
            class="form-textarea"></textarea>
        </div>

        <div class="info-box">
          <p>
            <strong>{{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.MODAL_NOTE' | translate }}</strong> {{
            'INSTRUCTOR_PERFORMANCE.STUDENTS.MODAL_MSG_SENT_TO' | translate }} {{ selectedStudentForAction?.email }}
          </p>
        </div>
      </div>

      <div class="modal-footer">
        <button (click)="closeMessageModal()" class="btn-cancel">{{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.MODAL_BTN_CANCEL' |
          translate }}</button>
        <button (click)="sendMessage()" [disabled]="!messageSubject.trim() || !messageText.trim()" class="btn-primary">
          {{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.MODAL_BTN_SEND' | translate }}
        </button>
      </div>
    </div>
  </div>

  <!-- Performance Modal -->
  <div *ngIf="showPerformanceModal" class="modal-overlay" (click)="closePerformanceModal()">
    <div class="modal-content modal-large" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="performance-header">
          <div class="avatar">{{ getInitials(selectedStudentForAction!.name) }}</div>
          <div>
            <h2>{{ selectedStudentForAction?.name }}</h2>
            <p class="modal-subtitle">{{ selectedStudentForAction?.email }}</p>
          </div>
        </div>
        <button class="close-btn" (click)="closePerformanceModal()">‚úï</button>
      </div>

      <div class="modal-body modal-scroll">
        <!-- Performance Stats -->
        <div class="stats-grid">
          <div class="stat-card stat-blue">
            <div class="stat-card-header">
              <span>{{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.STAT_TOTAL_COURSES' | translate }}</span>
              <span class="icon">üéØ</span>
            </div>
            <p class="stat-card-value">
              {{ calculateStudentStats(selectedStudentForAction!).totalCourses }}
            </p>
          </div>

          <div class="stat-card stat-green">
            <div class="stat-card-header">
              <span>{{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.COMPLETED_BADGE' | translate }}</span>
              <span class="icon">üèÜ</span>
            </div>
            <p class="stat-card-value">
              {{ calculateStudentStats(selectedStudentForAction!).completedCourses }}
            </p>
          </div>

          <div class="stat-card stat-purple">
            <div class="stat-card-header">
              <span>{{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.STAT_AVG_PROGRESS' | translate }}</span>
              <span class="icon">üìà</span>
            </div>
            <p class="stat-card-value">
              {{ calculateStudentStats(selectedStudentForAction!).avgProgress }}%
            </p>
          </div>

          <div class="stat-card stat-yellow">
            <div class="stat-card-header">
              <span>{{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.STAT_AVG_RATING' | translate }}</span>
              <span class="icon">‚≠ê</span>
            </div>
            <p class="stat-card-value">
              {{ calculateStudentStats(selectedStudentForAction!).avgRating }}
            </p>
          </div>
        </div>

        <!-- Additional Info -->
        <div class="info-grid">
          <div class="info-box-gray">
            <h3>‚è±Ô∏è {{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.ACTIVITY' | translate }}</h3>
            <div class="info-rows">
              <div class="info-row">
                <span>{{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.STAT_TOTAL_WATCH_TIME' | translate }}</span>
                <span class="info-value">{{ selectedStudentForAction?.totalWatchTime }}</span>
              </div>
              <div class="info-row">
                <span>{{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.STAT_COUNTRY' | translate }}</span>
                <span class="info-value">{{ selectedStudentForAction?.country }}</span>
              </div>
              <div class="info-row">
                <span>{{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.STAT_TOTAL_RATINGS' | translate }}</span>
                <span class="info-value">
                  {{ calculateStudentStats(selectedStudentForAction!).totalRatings }}
                </span>
              </div>
            </div>
          </div>

          <div class="info-box-gray">
            <h3>{{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.QUICK_ACTIONS' | translate }}</h3>
            <div class="quick-actions">
              <button (click)="openMessageFromPerformance()" class="btn-primary btn-block">
                üí¨ {{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.QUICK_ACTIONS_MSG' | translate }}
              </button>
              <button class="btn-secondary btn-block">{{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.VIEW_ALL_REVIEWS_BTN' |
                translate }}</button>
            </div>
          </div>
        </div>

        <!-- Course Performance Details -->
        <div class="performance-details">
          <h3 class="section-title">{{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.COURSE_PERFORMANCE' | translate }}</h3>
          <div class="courses-detail-list">
            <div *ngFor="let course of selectedStudentForAction?.enrolledCourses" class="course-detail-card">
              <div class="course-detail-header">
                <div>
                  <h4>{{ course.title }}</h4>
                  <div class="course-detail-meta">
                    <span>{{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.ENROLLED_DATE' | translate }} {{ course.enrollDate
                      }}</span>
                    <span>‚Ä¢</span>
                    <span>{{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.LAST_ACCESSED' | translate }} {{ course.lastAccessed
                      }}</span>
                  </div>
                </div>
                <div *ngIf="course.progress === 100" class="completed-badge-large">
                  <span class="icon">üèÜ</span>
                  {{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.COMPLETED_BADGE' | translate }}
                </div>
              </div>

              <div class="course-detail-progress">
                <div class="progress-info">
                  <span>{{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.PROGRESS_LABEL' | translate }}</span>
                  <span class="progress-value">{{ course.progress }}%</span>
                </div>
                <div class="progress-bar-container">
                  <div class="progress-bar" [ngClass]="getProgressColor(course.progress)"
                    [style.width.%]="course.progress"></div>
                </div>
              </div>

              <div class="course-detail-footer">
                <div>
                  <span class="rating-label-small">{{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.RATING_LABEL' | translate }}:
                  </span>
                  <span *ngIf="course.rating" class="stars-small">
                    <span *ngFor="let star of getStarArray(course.rating)"
                      [class.filled]="star <= course.rating">‚òÖ</span>
                  </span>
                  <span *ngIf="!course.rating" class="no-rating-small">{{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.NO_RATING' |
                    translate }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button (click)="closePerformanceModal()" class="btn-secondary">{{ 'INSTRUCTOR_PERFORMANCE.STUDENTS.CLOSE' |
          translate }}</button>
      </div>
    </div>
  </div>
</div>