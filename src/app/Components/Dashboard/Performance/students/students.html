<div class="students-container">
  <!-- Top Navigation -->
  <div class="top-nav">
    <div class="max-w-7xl">
      <div class="nav-content">
        <div>
          <h1>Students</h1>
          <p class="subtitle">
            {{ stats.totalStudents }} student{{ stats.totalStudents !== 1 ? 's' : '' }} ‚Ä¢
            {{ stats.totalCourses }} enrollment{{ stats.totalCourses !== 1 ? 's' : '' }}
            <ng-container *ngIf="activeTab === 'completed'"> ‚Ä¢ {{ stats.completedCourses }} completed</ng-container>
            <ng-container *ngIf="activeTab === 'in-progress'"> ‚Ä¢ {{ stats.inProgressCourses }} in
              progress</ng-container>
          </p>
        </div>
      </div>
    </div>
  </div>

  <div class="max-w-7xl content-area">
    <!-- Tabs -->
    <div class="tabs">
      <button [class.active]="activeTab === 'all'" (click)="activeTab = 'all'; onFilterChange()">
        All students
      </button>
      <button [class.active]="activeTab === 'in-progress'" (click)="activeTab = 'in-progress'; onFilterChange()">
        In progress
        <span class="badge">{{ inProgressCount }}</span>
      </button>
      <button [class.active]="activeTab === 'completed'" (click)="activeTab = 'completed'; onFilterChange()">
        Completed
        <span class="badge">{{ completedCount }}</span>
      </button>
    </div>

    <!-- Search and Filters -->
    <div class="filters">
      <div class="search-box">
        <span class="search-icon">üîç</span>
        <input type="text" placeholder="Search by student or course..." [(ngModel)]="searchTerm"
          (input)="onFilterChange()">
      </div>
      <div class="select-wrapper">
        <select [(ngModel)]="selectedCourse" (change)="onFilterChange()">
          <option *ngFor="let course of courses" [value]="course">
            {{ course === 'all' ? 'All courses' : course }}
          </option>
        </select>
      </div>
    </div>

    <!-- Students List -->
    <div class="students-list">
      <div *ngFor="let student of filteredStudents" class="student-card">
        <!-- Student Header -->
        <div class="student-header" (click)="toggleExpand(student.id)">
          <div class="student-main">
            <div class="avatar">{{ getInitials(student.name) }}</div>
            <div class="student-details">
              <div class="name-row">
                <h3>{{ student.name }}</h3>
                <span class="separator">‚Ä¢</span>
                <span class="country">{{ student.country }}</span>
              </div>
              <p class="email">{{ student.email }}</p>
            </div>
          </div>
          <div class="student-stats">
            <div class="stat">
              <p class="stat-label">Courses</p>
              <p class="stat-value">{{ student.enrolledCourses.length }}</p>
            </div>
            <div class="stat">
              <p class="stat-label">Watch time</p>
              <p class="stat-value">{{ student.totalWatchTime }}</p>
            </div>
            <span class="chevron" [class.rotated]="expandedStudent === student.id">‚ñº</span>
          </div>
        </div>

        <!-- Expanded Course Details -->
        <div *ngIf="expandedStudent === student.id" class="expanded-content">
          <div *ngFor="let course of student.enrolledCourses" class="course-item">
            <div class="course-header">
              <div class="course-info">
                <h4>{{ course.title }}</h4>
                <div class="course-meta">
                  <span>üìÖ Enrolled {{ course.enrollDate }}</span>
                  <span>‚Ä¢</span>
                  <span>Last accessed {{ course.lastAccessed }}</span>
                </div>
              </div>
              <div class="course-badges">
                <div class="rating-box">
                  <p class="rating-label">Rating</p>
                  <div *ngIf="course.rating" class="stars">
                    <span *ngFor="let star of getStarArray(course.rating)"
                      [class.filled]="star <= course.rating">‚òÖ</span>
                  </div>
                  <span *ngIf="!course.rating" class="no-rating">No rating yet</span>
                </div>
                <div *ngIf="course.progress === 100" class="completed-badge">
                  <span class="icon">üèÜ</span>
                  <span>Completed</span>
                </div>
              </div>
            </div>

            <div class="progress-row">
              <div class="progress-bar-container">
                <div class="progress-bar" [ngClass]="getProgressColor(course.progress)"
                  [style.width.%]="course.progress"></div>
              </div>
              <span class="progress-text">{{ course.progress }}%</span>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="action-buttons">
            <button (click)="openMessageModal(student)" class="btn-secondary">
              <span class="icon">üí¨</span>
              Message student
            </button>
            <button (click)="openPerformanceModal(student)" class="btn-secondary">
              <span class="icon">üìä</span>
              View performance
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- No Results -->
    <div *ngIf="filteredStudents.length === 0" class="no-results">
      <p class="no-results-title">No students found</p>
      <p class="no-results-subtitle">Try adjusting your search or filters</p>
    </div>
  </div>

  <!-- Message Modal -->
  <div *ngIf="showMessageModal" class="modal-overlay" (click)="closeMessageModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div>
          <h2>Send Message</h2>
          <p class="modal-subtitle">To: {{ selectedStudentForAction?.name }}</p>
        </div>
        <button class="close-btn" (click)="closeMessageModal()">‚úï</button>
      </div>

      <div class="modal-body">
        <div class="form-group">
          <label>Subject</label>
          <input type="text" [(ngModel)]="messageSubject" placeholder="Enter message subject..." class="form-input">
        </div>

        <div class="form-group">
          <label>Message</label>
          <textarea [(ngModel)]="messageText" placeholder="Write your message here..." rows="8"
            class="form-textarea"></textarea>
        </div>

        <div class="info-box">
          <p>
            <strong>Note:</strong> This message will be sent to {{ selectedStudentForAction?.email }}
          </p>
        </div>
      </div>

      <div class="modal-footer">
        <button (click)="closeMessageModal()" class="btn-cancel">Cancel</button>
        <button (click)="sendMessage()" [disabled]="!messageSubject.trim() || !messageText.trim()" class="btn-primary">
          Send Message
        </button>
      </div>
    </div>
  </div>

  <!-- Performance Modal -->
  <div *ngIf="showPerformanceModal" class="modal-overlay" (click)="closePerformanceModal()">
    <div class="modal-content modal-large" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="performance-header">
          <div class="avatar">{{ getInitials(selectedStudentForAction!.name) }}</div>
          <div>
            <h2>{{ selectedStudentForAction?.name }}</h2>
            <p class="modal-subtitle">{{ selectedStudentForAction?.email }}</p>
          </div>
        </div>
        <button class="close-btn" (click)="closePerformanceModal()">‚úï</button>
      </div>

      <div class="modal-body modal-scroll">
        <!-- Performance Stats -->
        <div class="stats-grid">
          <div class="stat-card stat-blue">
            <div class="stat-card-header">
              <span>Total Courses</span>
              <span class="icon">üéØ</span>
            </div>
            <p class="stat-card-value">
              {{ calculateStudentStats(selectedStudentForAction!).totalCourses }}
            </p>
          </div>

          <div class="stat-card stat-green">
            <div class="stat-card-header">
              <span>Completed</span>
              <span class="icon">üèÜ</span>
            </div>
            <p class="stat-card-value">
              {{ calculateStudentStats(selectedStudentForAction!).completedCourses }}
            </p>
          </div>

          <div class="stat-card stat-purple">
            <div class="stat-card-header">
              <span>Avg Progress</span>
              <span class="icon">üìà</span>
            </div>
            <p class="stat-card-value">
              {{ calculateStudentStats(selectedStudentForAction!).avgProgress }}%
            </p>
          </div>

          <div class="stat-card stat-yellow">
            <div class="stat-card-header">
              <span>Avg Rating</span>
              <span class="icon">‚≠ê</span>
            </div>
            <p class="stat-card-value">
              {{ calculateStudentStats(selectedStudentForAction!).avgRating }}
            </p>
          </div>
        </div>

        <!-- Additional Info -->
        <div class="info-grid">
          <div class="info-box-gray">
            <h3>‚è±Ô∏è Activity</h3>
            <div class="info-rows">
              <div class="info-row">
                <span>Total watch time:</span>
                <span class="info-value">{{ selectedStudentForAction?.totalWatchTime }}</span>
              </div>
              <div class="info-row">
                <span>Country:</span>
                <span class="info-value">{{ selectedStudentForAction?.country }}</span>
              </div>
              <div class="info-row">
                <span>Total ratings given:</span>
                <span class="info-value">
                  {{ calculateStudentStats(selectedStudentForAction!).totalRatings }}
                </span>
              </div>
            </div>
          </div>

          <div class="info-box-gray">
            <h3>Quick Actions</h3>
            <div class="quick-actions">
              <button (click)="openMessageFromPerformance()" class="btn-primary btn-block">
                üí¨ Send Message
              </button>
              <button class="btn-secondary btn-block">View All Reviews</button>
            </div>
          </div>
        </div>

        <!-- Course Performance Details -->
        <div class="performance-details">
          <h3 class="section-title">Course Performance</h3>
          <div class="courses-detail-list">
            <div *ngFor="let course of selectedStudentForAction?.enrolledCourses" class="course-detail-card">
              <div class="course-detail-header">
                <div>
                  <h4>{{ course.title }}</h4>
                  <div class="course-detail-meta">
                    <span>Enrolled: {{ course.enrollDate }}</span>
                    <span>‚Ä¢</span>
                    <span>Last accessed: {{ course.lastAccessed }}</span>
                  </div>
                </div>
                <div *ngIf="course.progress === 100" class="completed-badge-large">
                  <span class="icon">üèÜ</span>
                  Completed
                </div>
              </div>

              <div class="course-detail-progress">
                <div class="progress-info">
                  <span>Progress</span>
                  <span class="progress-value">{{ course.progress }}%</span>
                </div>
                <div class="progress-bar-container">
                  <div class="progress-bar" [ngClass]="getProgressColor(course.progress)"
                    [style.width.%]="course.progress"></div>
                </div>
              </div>

              <div class="course-detail-footer">
                <div>
                  <span class="rating-label-small">Rating: </span>
                  <span *ngIf="course.rating" class="stars-small">
                    <span *ngFor="let star of getStarArray(course.rating)"
                      [class.filled]="star <= course.rating">‚òÖ</span>
                  </span>
                  <span *ngIf="!course.rating" class="no-rating-small">No rating yet</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button (click)="closePerformanceModal()" class="btn-secondary">Close</button>
      </div>
    </div>
  </div>
</div>