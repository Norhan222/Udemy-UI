<div class="course-details-container" *ngIf="!loading">
  <!-- Header Section -->
  <div class="course-header">
    <div class="container">
      <div class="header-content">
        <div class="header-info">
          <div class="breadcrumb">
            <a href="#">{{ 'COURSE_DETAILS.HEADER.HOME' | translate }}</a> / <a href="#">{{ course!.category }}</a> /
            <span>{{ course!.title }}</span>
          </div>
          <h1 class="course-title">{{ course!.title }}</h1>
          <div class="course-meta-row">
            <!-- <span class="course-id">Course ID: {{ course!.id }}</span> -->
            <span class="course-description">{{ course!.description }}</span>
          </div>
          <div class="rating-info">
            <div class="rating">
              <span class="stars">{{ getRatingStars(course!.rating) }}</span>
              <span class="rating-number">{{ course!.rating }}</span>
              <span class="review-count">({{ formatNumber(course!.reviewCount) }} ratings)</span>
            </div>
            <span class="student-count">{{ formatNumber(course!.studentCount) }} students</span>
          </div>
          <div class="meta-info">
            <span *ngIf="course!.instructors && course!.instructors.length > 0">{{ 'COURSE_DETAILS.HEADER.CREATED_BY' |
              translate }} <strong>{{ course!.instructors[0].name }}</strong></span>
            <span *ngIf="!(course!.instructors && course!.instructors.length > 0)">{{ 'COURSE_DETAILS.HEADER.CREATED_BY'
              | translate }} <strong>{{ 'COURSE_DETAILS.HEADER.UNKNOWN' | translate }}</strong></span>
            <span>{{ 'COURSE_DETAILS.HEADER.LAST_UPDATED' | translate }} {{ course!.lastUpdated }}</span>
            <span>{{ course!.language }}</span>
          </div>
        </div>
        <div class="header-thumbnail">
          <img [src]="course!.thumbnail" [alt]="course!.title" />
          <button class="play-button" (click)="openVideoModal()">
            <span class="play-icon">‚ñ∂</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Video Modal -->
  <div class="video-modal" *ngIf="showVideoModal" (click)="closeVideoModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <button class="close-button" (click)="closeVideoModal()">√ó</button>
      <video controls autoplay>
        <source [src]="course!.videoPreview" type="video/mp4" />
        Your browser does not support the video tag.
      </video>
    </div>
  </div>

  <div class="container main-content">
    <!-- Main Content -->
    <div class="course-main">
      <!-- What You'll Learn -->
      <section class="learning-section" *ngIf="course!.whatYouWillLearn && course!.whatYouWillLearn.length">
        <h2>{{ 'COURSE_DETAILS.WHAT_YOU_WILL_LEARN.TITLE' | translate }}</h2>
        <div class="learning-grid">
          <div class="learning-item" *ngFor="let item of course!.whatYouWillLearn">
            <span class="checkmark">‚úì</span>
            <span>{{ item }}</span>
          </div>
        </div>
      </section>

      <!-- Curriculum -->
      <section class="curriculum-section">
        <h2>{{ 'COURSE_DETAILS.CURRICULUM.TITLE' | translate }}</h2>
        <div class="curriculum-header">
          <span>{{ (course!.curriculum || []).length }} {{ 'COURSE_DETAILS.CURRICULUM.SECTIONS' | translate }}</span>
          <span>{{ course!.duration }} {{ 'COURSE_DETAILS.CURRICULUM.TOTAL_LENGTH' | translate }}</span>
        </div>
        <div class="curriculum-list">
          <div *ngIf="!(course!.curriculum && course!.curriculum.length)">{{ 'COURSE_DETAILS.CURRICULUM.NO_CURRICULUM' |
            translate }}</div>
          <div class="curriculum-section-item" *ngFor="let section of course!.curriculum"
            [class.expanded]="isSectionExpanded(section.sectionId)">
            <div class="section-header" (click)="toggleSection(section.sectionId)">
              <span class="section-title">
                <i class="arrow">{{ isSectionExpanded(section.sectionId) ? '‚ñº' : '‚ñ∂' }}</i>
                {{ section.sectionTitle }}
              </span>
              <span class="lecture-count">{{ section.lectures.length }} {{ 'COURSE_DETAILS.CURRICULUM.LECTURES' |
                translate }}</span>
            </div>
            <div class="section-content" *ngIf="isSectionExpanded(section.sectionId)">
              <div class="lecture" *ngFor="let lecture of section.lectures">
                <div class="lecture-info">
                  <span class="lecture-icon">
                    {{ lecture.isFree ? 'üé•' : 'üîí' }}
                  </span>
                  <span class="lecture-title">{{ lecture.title }}</span>
                  <span class="lecture-duration">{{ lecture.duration }}</span>
                </div>
                <span class="free-badge" *ngIf="lecture.isFree">{{ 'COURSE_DETAILS.CURRICULUM.FREE' | translate
                  }}</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Requirements -->
      <section class="requirements-section" *ngIf="course!.requirements && course!.requirements.length">
        <h2>{{ 'COURSE_DETAILS.REQUIREMENTS.TITLE' | translate }}</h2>
        <ul class="requirements-list">
          <li *ngFor="let requirement of course!.requirements">{{ requirement }}</li>
        </ul>
      </section>

      <!-- Instructors -->
      <section class="instructors-section">
        <h2>{{ 'COURSE_DETAILS.INSTRUCTORS.TITLE' | translate }}</h2>
        <div class="instructors-list">
          <div class="instructor-card" *ngFor="let instructor of course!.instructors">
            <img [src]="instructor.image" [alt]="instructor.name" class="instructor-image" />
            <div class="instructor-info">
              <h3>{{ instructor.name }}</h3>
              <p class="instructor-title">{{ instructor.title }}</p>
              <div class="instructor-stats">
                <span>{{ instructor.rating }} ‚òÖ</span>
                <span>{{ formatNumber(instructor.students) }} {{ 'COURSE_DETAILS.INSTRUCTORS.STUDENTS' | translate
                  }}</span>
              </div>
              <p class="instructor-bio">{{ instructor.bio }}</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Reviews -->
      <section class="reviews-section">
        <h2>{{ 'COURSE_DETAILS.REVIEWS.TITLE' | translate }}</h2>
        <div class="reviews-header">
          <div class="overall-rating">
            <div class="rating-large">{{ course!.rating }}</div>
            <div class="stars-large">{{ getRatingStars(course!.rating) }}</div>
            <div class="total-ratings">{{ formatNumber(course!.reviewCount) }} {{ 'COURSE_DETAILS.REVIEWS.RATINGS' |
              translate }}</div>
          </div>
        </div>
        <div class="reviews-list">
          <div class="review-item" *ngFor="let review of course!.reviews">
            <div class="review-header">
              <img [src]="review.userImage" [alt]="review.userName" class="user-image" />
              <div class="review-user-info">
                <h4>{{ review.userName }}</h4>
                <div class="review-rating">{{ getRatingStars(review.rating) }}</div>
                <p class="review-date">{{ review.date }}</p>
              </div>
            </div>
            <h5 class="review-title">{{ review.title }}</h5>
            <p class="review-description">{{ review.description }}</p>
            <button class="helpful-button">üëç {{ 'COURSE_DETAILS.REVIEWS.HELPFUL' | translate }} ({{ review.helpful
              }})</button>
          </div>
        </div>
      </section>
    </div>

    <!-- Sidebar -->
    <aside class="course-sidebar">
      <div class="purchase-panel">
        <div class="coupon-banner" *ngIf="couponApplied">
          {{ couponApplied }} {{ 'COURSE_DETAILS.SIDEBAR.COUPON_APPLIED' | translate }} ‚Ä¢ <strong>{{
            'COURSE_DETAILS.SIDEBAR.UDEMY_COUPON' | translate }}</strong>
        </div>
        <!-- 
        <div class="panel-tabs">
          <button class="tab active">Full course</button>
          <button class="tab">Certificate</button> -->
        <!-- In your sticky sidebar, after "Add to Cart" button -->
        <!-- </div> -->

        <div class="price-amount">
          <div class="price-row">
            <div class="current-price">${{ course!.price }}</div>
            <div class="original-price">${{ course!.originalPrice }}</div>
          </div>
          <div class="price-note">{{ 'COURSE_DETAILS.SIDEBAR.INCLUDES_ACCESS' | translate }} ‚Ä¢ {{
            'COURSE_DETAILS.SIDEBAR.MONEY_BACK' | translate }}</div>
        </div>

        <!-- <button class="primary-cta" (click)="addToCart(course?.id)">{{ cartAdded ? '‚úì Added to Cart' : 'Add to cart' }}</button> -->
        <!-- <button class="primary-cta" (click)="addToCart(course?.id)"> Added to Cart</button> -->
        <button class="primary-cta" [disabled]="isInCart(course?.id)" (click)="addToCart(course?.id)">
          {{ isInCart(course?.id) ? ('COURSE_DETAILS.SIDEBAR.ADDED_TO_CART' | translate) :
          ('COURSE_DETAILS.SIDEBAR.ADD_TO_CART' | translate) }}
        </button>

        <!-- Your button -->
        <!-- FOR TESTING - ALWAYS SHOW BUTTON -->
        <!-- Replace your existing wishlist button with this code -->

        <button (click)="addWishlist(course!.id)" [disabled]="movingToWishlist || isInWishlist(course?.id)"
          class="btn b-2 w-100 mt-2 secondary-cta">

          <span *ngIf="!movingToWishlist && !isInWishlist(course?.id)">
            {{ 'COURSE_DETAILS.SIDEBAR.MOVE_TO_WISHLIST' | translate }}
          </span>

          <span *ngIf="movingToWishlist">
            <span class="spinner-border spinner-border-sm me-2"></span>
            {{ 'COURSE_DETAILS.SIDEBAR.MOVING' | translate }}
          </span>

          <span *ngIf="isInWishlist(course?.id)">
            ‚úì {{ 'COURSE_DETAILS.SIDEBAR.IN_WISHLIST' | translate }}
          </span>
        </button>

        <button class="secondary-cta" (click)="buyNow()">{{ 'COURSE_DETAILS.SIDEBAR.BUY_NOW' | translate }}</button>
        <div class="coupon-row">
          <input class="coupon-input" [placeholder]="'COURSE_DETAILS.SIDEBAR.COUPON_PLACEHOLDER' | translate" />
          <button class="apply-coupon">{{ 'COURSE_DETAILS.SIDEBAR.APPLY' | translate }}</button>
        </div>

        <div class="money-back tiny-note">
          {{ 'COURSE_DETAILS.SIDEBAR.MONEY_BACK' | translate }}
        </div>
      </div>

      <div class="course-features">
        <h3>{{ 'COURSE_DETAILS.SIDEBAR.THIS_COURSE_INCLUDES' | translate }}</h3>
        <ul class="features-list">
          <li *ngFor="let feature of course!.features">
            <span class="feature-icon">‚úì</span>
            {{ feature }}
          </li>
        </ul>
      </div>

      <div class="course-info-card">
        <h3>{{ 'COURSE_DETAILS.SIDEBAR.DETAILS_TITLE' | translate }}</h3>
        <div class="info-item">
          <span class="label">{{ 'COURSE_DETAILS.SIDEBAR.LEVEL' | translate }}</span>
          <span class="value">{{ course!.level }}</span>
        </div>
        <div class="info-item">
          <span class="label">{{ 'COURSE_DETAILS.SIDEBAR.DURATION' | translate }}</span>
          <span class="value">{{ course!.duration }}</span>
        </div>
        <div class="info-item">
          <span class="label">{{ 'COURSE_DETAILS.SIDEBAR.LANGUAGE' | translate }}</span>
          <span class="value">{{ course!.language }}</span>
        </div>
        <div class="info-item">
          <span class="label">{{ 'COURSE_DETAILS.SIDEBAR.LAST_UPDATED' | translate }}</span>
          <span class="value">{{ course!.lastUpdated }}</span>
        </div>
      </div>
    </aside>
  </div>
</div>

<div class="loading" *ngIf="loading">
  <p>Loading course details...</p>
</div>